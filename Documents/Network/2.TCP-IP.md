# 0.序

TCP/IP 协议过去是一个，后来拆分为两个。  
应用程序使用 Socket 库和解析器 =>  
操作系统协议栈，包括 TCP(transmission control protocol)/UDP(user datagram protocol) 连接，以及下层的 IP(internet protocol)/ICMP(internet control message protocol)/ARP(address resolution protocol) 网络传输 =>  
驱动程序，主要是控制网卡的驱动程序 =>  
硬件，网卡

> TCP/UDP 协议用来接受应用程序的委托收发数据；  
> IP 协议用来控制网络包收发操作；  
> ICMP 协议用于告知网络包传送过程中的错误以及各种控制消息；  
> ARP 协议用于根据 IP 地址查询响应的以太网 MAC 地址；  
> 协议栈内部有一块用于存放控制信息的内存空间，记录了用于控制通信操作的控制信息，例如通信对象的 IP 地址、端口号、通信操作的进行状态。

# 1. socket 套接字

## 1.1 查看套接字

`netstat` 用来查看，展示信息包括协议类型（TCP/UDP）、本地 IP 地址和端口号、通信对象 IP 地址和端口号、通信状态（LISTENING/ESTABLISHED...）、进程标识符。

## 1.2 调用 socket

应用程序（浏览器）调用 gethostbyname(...)，通过 UDP 和 IP 模块查询 DNS 服务器。  
应用程序调用 socket(...) 创建套接字，分配一块内存空间，存储协议栈返回的描述符和其他对象同步信息，`控制信息`的一部分存储在这。  
应用程序调用 connect(...) 与服务器进行连接，获取服务器的 IP 地址和端口号等信息。客户端与服务器相互联络时交互`控制信息`，定义在 TCP 协议的头部中。

> 发送方端口号：16 bit，代表发送网络包的程序的端口号；  
> 接收方端口号：16 bit，代表网络包的接收方程序的端口号；  
> 序号：32 bit，发送方告知接收方该网络包发送的数据相当于所有发送数据的第几个字节；  
> ACK 号：32 bit，接收方告知发送方已经收到了所有数据的第几个字节；  
> 数据偏移量：4 bit，数据部分起始位置，即头部的长度；  
> 保留：6 bit，未使用，保留字段；  
> 控制位：6 bit，表示通信的控制含义，6 位分别代表 URG（紧急指针字段有效），ACK（接收数据需要字段有效，一般表示数据已被接收方收到），PSH（通过 flush 操作发送的数据），RST（强制断开连接，用于异常中断的情况），SYN（发送方和接收方确认序号，表示连接操作），FIN（表示断开连接）；  
> 窗口：16 bit，接收方告知发送方窗口大小；  
> 校验和：16 bit，用来检查是否出现错误；  
> 紧急指针：16 bit，表示应紧急处理的数据位置；
> 可选字段：可变长度，可添加可选字段，除了连接操作很少使用。

应用程序发出 `connect(<描述符>,<服务器 IP 地址和端口号>,...)`，在 TCP 模块创建表示上述连接控制信息的头部，TCP 模块将信息传递给 IP 模块并委托进行发送，网络包通过网络到达服务器，服务器 IP 模块将接受到的数据传递给 TCP 模块，服务器的 TCP 模块根据头部信息找到端口号对应的套接字，根据套接字写入响应信息，将状态修改为正在连接返回响应，网络包到达客户端，通过 IP 模块到达 TCP 模块，通过头部信息确认服务器连接操作是否成功，成功则将状态修改为连接完毕，ACK 信号位设置为 1 返回服务器。
